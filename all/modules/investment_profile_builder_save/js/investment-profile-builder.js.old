//$('.test').html('asd');
(function ($) {
  
		var userAnswersArr = [];
		var middlePassed = false;
		var startDirection;
		var questionTotal;
		var timmerExtra = '00';
		var baseURL = '';
		var stor;
		$( document ).ready(function() {
			
     // clean up the json that's coming in and output it 
      baseURL = Drupal.settings.investment_profile_builder_save.baseurl;
      questionData = JSON.parse(Drupal.settings.investment_profile_builder_save.question_data);
      questionData = JSON.parse(questionData);
      
        
       
			$('.bulb-brain').show();
			$('.bulb-brain').delay(100).animate({ 'background-position-y': "-8px" }, {duration: 1750}).animate({ 'background-position-y': "0px" }, {duration: 50});
			$('.speech-bubble-1').delay(20+timmerExtra).fadeIn(500);
			$('.speech-bubble-2').delay(25+timmerExtra).fadeIn(500);
			$('.speech-bubble-3').delay(24+timmerExtra).fadeIn(500);
			$('.speech-bubble-4').delay(21+timmerExtra).fadeIn(1000);      
			$('.brain-words').delay(10+timmerExtra).fadeIn(1+timmerExtra);
			$('.brain-btn-start').delay(22+timmerExtra).fadeIn(100);      
			
			
			$('.getStartedOK').click(function(){
      $('#irishlife-atrc-disclaimer').fadeOut('slow');
	  $('html, body').animate({ scrollTop: 0 }, 'fast');
				startQuestions();
			});
      
			$('.getStarted').click(function(){
				
				hideBrainExtras();
				slideBrain('left');
				showIntroText();
			});
      
        setupQuestions(questionData);
        /*
    // Get started by calling the json questions 
    $.ajax({
      url: baseURL+"/sites/all/modules/investment_profile_builder_save/js/atr-questions.json",
      data: {
        format: 'json'
      },
      error: function() {
        //$('#irishlife-atrc').html("<p style='color:red'>Error</p>");
      },
      success: function(data) {
        setupQuestions(data);
      },
      dataType: 'json',
      type: 'GET'
    });
	*/
	});

		
	function hideBrainExtras(){
		$('.investor-title,.brain-words,.speech-bubble-1,.speech-bubble-2,.speech-bubble-3,.speech-bubble-4,.brain-btn-start ').fadeOut();
    
		//$('.bulb-brain').animate({ 'background-position-y': "-10px" }, {duration: 300}).delay(100).animate({ 'background-position-y': "450px" }, {duration: 1000});
		$('.bulb-brain').removeClass('bulb-brain-img-full').addClass('bulb-brain-img-light');

	}
  function showIntroText(){
    $('#irishlife-atrc-disclaimer').fadeIn('slow');
  }
	function slideBrain(d){

    $('#irishlife-atrc-holder').css('background', 'transparent');

	}
	
	
	
	
	function addZero(num)
{
	(String(num).length < 2) ? num = String("0" + num) :  num = String(num);
	return num;		
}
	
	
		
  //####################################################################
  //# S E T T I N G   U P   G O O G L E   A N A L Y T I C S   C A L L S 
  //####################################################################
  // create a new IPB object - Investor Profile Builder object
  var myIPB = new Object(); 


  // set a virtual pageview 
  myIPB._setGAPageViewIPBStart = function() {
    myIPB._setGAPageView(window.location.pathname+'/questionnaire-start/','Investor Profile Builder Start')	
	myIPB._setSCamPageView(window.location.pathname+'/questionnaire-start/')
  }
  // set a virtual pageview 
  myIPB._setGAPageViewIPBMidway = function() {
    myIPB._setGAPageView(window.location.pathname+'/questionnaire-midpoint/','Investor Profile Builder Midpoint Reached')	
	myIPB._setSCamPageView(window.location.pathname+'/questionnaire-midpoint/')
  }
  // set a virtual pageview 
  myIPB._setGAPageViewIPBCompleted = function() {
  
    myIPB._setGAPageView(window.location.pathname+'/questionnaire-completed/','Investor Profile Builder Completed')
	myIPB._setSCamPageView(window.location.pathname+'/questionnaire-completed/')
	
    
  }
  // set a virtual pageview 
  myIPB._setGAEvent = function(category, action, label, value) {
  
    try{
    //tag manager
    dataLayer.push({
                  'event':'trackEvent',
                  'category':""+category,
                  'action':""+action,
                  'label':""+label,
                  'value':""+value
              });	
      }
      catch(err){
        //Do nothing
      }
            
  }
  
		// This is for calling pageviews dynamically on the page
  myIPB._setGAPageView = function(p,t){
    try{
    //tag manager
    dataLayer.push({
      'event':'pageview',
      'pageTitle':t,
      'virtualURL':p
      });		
    }
    catch(err){
      //Do nothing
    }
    //return "user set";
  }
  
  myIPB._setSCamPageView = function(p){
		try{
        //session cam call
        if(window.sessionCamRecorder) {
            if(window.sessionCamRecorder.createVirtualPageLoad)
            window.sessionCamRecorder.createVirtualPageLoad(p);
        }
			}
			catch(err){
				//Do nothing
			}
	//return "user set";
}



  
	function nextClick(){
  
  
  var starti = 0;
	//
	var currentAnswer = $('input:radio[name="answers"]:checked').val();
	userAnswersArr[currentQuestion] = currentAnswer;
	
	if(typeof userAnswersArr[currentQuestion] === "undefined")
	{
		$('#questionAnswerHolder').addClass("error");
	}
	else{
		$('#questionAnswerHolder').removeClass("error");
		
    myIPB._setGAEvent('Investor Profile Builder', 'Question Answered', currentQuestion+1, "1");
	//myIPB._setSCamPageView('');
    
		if(currentQuestion < (questionTotal-1)){
				currentQuestion++;
				//circleMove();
				$('.backBtn').show();
			}
			else if(currentQuestion ==(questionTotal-1) && !middlePassed)
			{
      // set the virtual log to display
      myIPB._setGAPageViewIPBMidway();
          $('.bulb-brain').addClass('bulb-brain-img-full').removeClass('bulb-brain-img-light');
				middlePassed = true;
				if(startDirection=="left")
				{
					slideBrain('right');
				}
				else{
					slideBrain('left');
				}
				
				questionTotal = questionsArr.length
				//alert("you've reached the end");
				
       
				
				$('#irishlife-atrc-questions').html('');
				$('.middle-results').delay(300).fadeIn();
				$('.middleNextBtn').click(function(){
          
        myIPB._setGAEvent('Investor Profile Builder', 'Question Answered', 'midpoint', "1");
				$('.middle-results').hide();
        
          $('.bulb-brain').removeClass('bulb-brain-img-full').addClass('bulb-brain-img-light');
      		startQuestions();
				});
				
			}
			else // last page
			{
      
				$('#irishlife-atrc-questions').html('');
				$('#irishlife-atrc-disclaimer').html('<br/><br/><br/><center><h3>Calculating the results. You will be redirected shortly. </h3></center>').fadeIn(200);
        
//        window.location = baseURL+"/investments/new-to-investing/2-careful-investor?source=ipb"

					
				//$('#irishlife-atrc-questions').html(divEndHTML);
        
        /********************************************************************************
        * 
        * 
        * This is the redirect on the last page.
        * Update the local storage and then redirect
        * to the page that we get for the result 
        * i.e. balanced, adventurous etc
        *
        *
        ********************************************************************************/
        
        /////////////////////////////////////////////////////////////////////////////////
        // Store off all the details in local storage
        var currentStorage;
        if(localStorage && localStorage.getItem('userInvestmentResults')){
          currentStorage = JSON.parse( localStorage.getItem( 'userInvestmentResults' ) )
          
              
        }
        var userInvestmentResults = {};
        if(localStorage){
            for(i=0; i<userAnswersArr.length; i++){
              userInvestmentResults['q'+(i+1)] = userAnswersArr[i];
              // pdfURL = pdfURL + "q" + (i+1) + "=" + userAnswersArr[i] + "&";
          }
          var d = new Date();
          var dt = addZero(d.getDate()) +"-"+addZero(d.getMonth()+1)+"-"+d.getFullYear()+" "+addZero(d.getHours())+":"+addZero(d.getMinutes())+":"+addZero(d.getSeconds());
          
          if (localStorage.getItem( 'userInvestmentResults' )){
          // not the first time doing this
            
            
            userInvestmentResults.firstCompleted = currentStorage.firstCompleted;
            userInvestmentResults.latestCompleted = dt;
            
            var c = parseInt(currentStorage.counter);
            if (c>=0){
              userInvestmentResults.counter = c+1;
            }
            else{
              userInvestmentResults.counter = 1;
            }
            
          }
          else{
            // first time doing this
            
            
            userInvestmentResults.firstCompleted = dt;
            userInvestmentResults.latestCompleted = dt;
            userInvestmentResults.counter = 1;
          }

          
          getResult(userInvestmentResults);
        }		
			}
      

				if(middlePassed){
					questionTotal = questionsArr.length;
					starti = Math.round(questionsArr.length/2);
				}
				//
				$('.meter-value').css({ "width": ""+((currentQuestion-starti)/((questionTotal-starti-1)))*100+"%" });
				
			if(middlePassed){
				starti = Math.round(questionsArr.length/2);
			}
			//
			var questionHead = questionsArr[currentQuestion].question;
			$('#questionHeadHolder').html((currentQuestion+1) + ". "+questionHead);
			if (questionsArr.length == currentQuestion+1)
			{
			$('.nextBtn').html('Get Your Profile');
			}
			for (i=1; i<=(currentQuestion-starti);i++){
				$('.circle-'+i).addClass('selected');
			}
			$('.circle').removeClass('hover');
			$('.circle-'+(currentQuestion+1-starti)).addClass('hover');
			
			populateAnswers();
			
			if(typeof userAnswersArr[currentQuestion] !== "undefined")
			{
				$( "#radio"+userAnswersArr[currentQuestion] ).prop( "checked", true );
			}
		}
	}
  
	function backClick(){
		$('.backBtn').hide();
		var starti = 0;
		if(middlePassed){
				questionTotal = questionsArr.length;
				starti = Math.round(questionsArr.length/2);
			}
	
			currentQuestion--;
      
      
    
		if(currentQuestion-starti > 0){
		
			$('.backBtn').show();
		}
		else
		{
	
			$('.backBtn').hide();
		}
		
		$('.meter-value').css({ "width": ""+((currentQuestion-starti)/((questionTotal-starti-1)))*100+"%" });
				
		
			if(middlePassed){
				starti = Math.round(questionsArr.length/2);
			}
		//
		var questionHead = questionsArr[currentQuestion].question;
		$('#questionHeadHolder').html("Q. "+questionHead);
		$('.circle').removeClass('selected');
		for (i=1; i<=currentQuestion-starti;i++){
				
			$('.circle-'+i).addClass('selected');
		}
		$('.circle').removeClass('hover');
		$('.circle-'+(currentQuestion+1-starti)).addClass('hover');
		
		//populateAnswers();
		
		
		
		if(typeof userAnswersArr[currentQuestion] !== "undefined")
		{
			$( "#radio"+userAnswersArr[currentQuestion] ).prop( "checked", true );
		}
			
	}
	
	
	
	
	
	function populateAnswers(){
	//
	
		var questionAnswers = '<span id="questionAnswerHolder">';
			
		var s = questionsArr[currentQuestion].answers[0];
		
		if(typeof s.a !== 'undefined' && s.a.length)
		{	
			
			
			questionAnswers = questionAnswers + '<input type="radio" id="radioa" name="answers" value="1"  />\
			<label for="radioa" class="radioOption start"><span id="q-label-1">A. '+s.a+'</span><span class="checked"></span></label>';
			
		}
		if(typeof s.b !== 'undefined' && s.b.length)
		{	
			
			questionAnswers = questionAnswers + '<input type="radio" id="radiob" name="answers" value="2"  />\
			<label for="radiob" class="radioOption offset "><span id="q-label-2">B. '+s.b+'</span><span class="checked"></span></label>';
		}
		if(typeof s.c !== 'undefined' && s.c.length)
		{	
			
			questionAnswers = questionAnswers + '<input type="radio" id="radioc" name="answers" value="3"  />\
			<label for="radioc" class="radioOption "><span id="q-label-3">C. '+s.c+'</span><span class="checked"></span></label>';
		}
		if(typeof s.d !== 'undefined' && s.d.length)
		{	
			
			questionAnswers = questionAnswers + '<input type="radio" id="radiod" name="answers" value="4"  />\
			<label for="radiod" class="radioOption offset "><span id="q-label-4">D. '+s.d+'</span><span class="checked"></span></label>';
		}
		if(typeof s.e !== 'undefined' && s.e.length)
		{	
			
			questionAnswers = questionAnswers + '<input type="radio" id="radioe" name="answers" value="5"  />\
			<label for="radioe" class="radioOption "><span id="q-label-5">E. '+s.e+'</span><span class="checked"></span></label>';
		}
		if(typeof s.f !== 'undefined' && s.f.length)
		{	
			
			questionAnswers = questionAnswers + '<input type="radio" id="radiof" name="answers" value="6"  />\
			<label for="radiof" class="radioOption offset "><span id="q-label-6">F. '+s.f+'</span><span class="checked"></span></label>';
		}
		questionAnswers = questionAnswers + '</span>';
	
	
		$('#questionAnswerHolder').html(questionAnswers);
	
	}
	
	function circleMove(){
    var starti = 0;
		if(middlePassed){
				questionTotal = questionsArr.length;
				starti = Math.round(questionsArr.length/2);
			}
		var allCircles = "";//"<div class='circle selected circle-0'></div>";
		var lenArr = questionTotal-1-starti;
			
		for(i=0; i<=lenArr; i++){
			var num = (i/(lenArr))*100;
			if(i==0){
				
				var aCircle = '<div class="circle hover circle-'+(i+1)+'" style="left:'+num+'%"></div>'
			}
			else{
				var aCircle = '<div class="circle circle-'+(i+1)+'" style="left:'+num+'%"></div>'
			}
			//var aCircle = '<div class="circle" style="left:5%"></div>'
			allCircles = allCircles+""+aCircle;
		}
		
		var allCircles =allCircles;//+ "<div class='circle' style='right:-15px;'></div>";
		$('.circleholder').html(allCircles);
	}
	
	// Start the question process here
	//
	function startQuestions(){
	// if we've passed the first half of the questions 
	// then start in the middle
	//
			if(middlePassed){
				currentQuestion++;
				questionTotal = questionsArr.length - Math.round(questionsArr.length/2);
			}
	
				//questionTotal = Math.round(questionsArr.length/2);
				
				
				//###############################
		var progressindicator = '<div class="meter-wrap" >\
			<span class="circleholder"></span>\
			<div class="meter-value" style="width: 0%;">\
				<div class="meter-text">\
				</div>\
			</div>\
		</div>';
		var questionHead = "<span id='questionHeadHolder'>"+(currentQuestion+1) + ". " + questionsArr[currentQuestion].question + "</span>";
		
		var questionAnswers = '<span id="questionAnswerHolder"></span>';
		
		var nextButton = '<a href="javascript:void(0)" class="nextBtn moveBtn" >Next</a>';
		
		var fullHTML = progressindicator + questionHead + questionAnswers + nextButton;
		$('#irishlife-atrc-questions').hide();
		$('#irishlife-atrc-questions').html(""+fullHTML);
		populateAnswers();
		if(typeof userAnswersArr[currentQuestion] !== "undefined")
		{
			$( "#radio"+userAnswersArr[currentQuestion] ).prop( "checked", true );
		}

		
		
		$('#irishlife-atrc-questions').delay(500).slideDown('slow');

		circleMove();
		
		$('.nextBtn').click(function(){
			nextClick();
		});
		$('.backBtn').click(function(){
			backClick();
		});

	}
	
  var resultsArr = new Array();
  function setupResults(resultJson){

    var resultScore = resultJson[0].score[0].id;
    
  // array of questions
      $.each( resultJson[0].results, function( index, value ) {
      
      
      var resultList = new Object();
      resultList.id = value.id;
      resultList.title = value.title;
      resultList.text = value.text;
      resultList.chartImg = baseURL+"/sites/all/modules/investment_profile_builder_save/img/find-mix-"+value.id+".png";//value.chartImg;
      
      resultsArr[index] = resultList;
      
      //
      
      
      });
      
      updateResults(resultScore);
	}
  
  function updateResults(score){
  var curr = score-1;
  
    $('.score-mainscore-full').html(resultsArr[curr].title).removeClass('score-mainscore-main-1 score-mainscore-main-2 score-mainscore-main-3 score-mainscore-main-4 score-mainscore-main-5 score-mainscore-main-6 score-mainscore-main-7').addClass('score-mainscore-main-'+score);
    $('.final-result-text-contents').html(''+resultsArr[curr].text+'<img src="'+resultsArr[curr].chartImg+'" width="150px">');
   //   $('.final-result-text').perfectScrollbar('update');
  }
		
    
    
	function getResult(localStorageData){
		stor = localStorageData;
		// make a call to the database to pull down the JSON
		// var resultData = "showFunds=Y&b2c=N&internal=N&alternative1=A4&alternative2=A3&alternative3=A5&alternative4=A5&alternative5=A4&alternative6=A3&alternative7=A4&alternative8=A4&alternative9=A4&alternative10=A5&alternative11=A4&callback_name=?"
		
		var s = questionsArr[currentQuestion].answers[0];
		var urlParams = "";
    
		for(i=0; i<userAnswersArr.length; i++){
				  // pdfURL = pdfURL + "q" + (i+1) + "=" + userAnswersArr[i] + "&";
				  urlParams += "alternative"+(i+1)+"=A"+userAnswersArr[i]+"&";
		}
		// make a call to the google analytics tag manager to 
		 // register that the user has completed the questionnaire 
		 myIPB._setGAPageViewIPBCompleted();    
		 loadScript("/servlet/calcRiskProfile.do?resultOnly=Y&"+urlParams,scriptLoaded,urlParams);
	}

	var questionsArr = new Array();
	var currentQuestion = 0;

	function setupQuestions(questionJson){

		// array of questions
				$.each( questionJson[0].questions, function( index, value ) {
				//
				
				var questionList = new Object();
				questionList.id = value.id;
				questionList.head = value.head;
				questionList.question = value.question;
				questionList.answers = value.answers;
				
				questionsArr[index] = questionList;
				
				//
				
				//questionsArr.length = 6;
				questionTotal = Math.round(questionsArr.length/2);
				});
	}
  
	function loadScript(url, callback, params) {

	var script = document.createElement("script")
        script.type = "text/javascript";

        if (script.readyState) { //IE
            script.onreadystatechange = function () {
                if (script.readyState == "loaded" || script.readyState == "complete") {
                    script.onreadystatechange = null;
                    callback(params);
                }
            };
        } else { //Others
            script.onload = function () {
                callback(params);
            };
        }
        script.src = url;
        document.getElementsByTagName("head")[0].appendChild(script);
    }
	
	//the script should be loaded now and we can interrogate the result and go to the appropriate page	
	function scriptLoaded(params)
	{
		if (localStorage.getItem( 'userInvestmentResults' )){
            // not the first time doing this
              stor['firstScore'] = stor['firstScore'];
              stor['currentScore'] = riskRating;
            // 
            }
            else{
           // 
            
              stor['firstScore'] = riskRating;
              stor['currentScore'] = riskRating;
            }
          // 
          myIPB._setGAEvent('Investor Profile Builder', 'Result Received', "r-f"+riskRating, "1");
          localStorage.setItem( 'userInvestmentResults', JSON.stringify(stor) );
		  localStorage.setItem( 'investorType',riskRating);
		  
		  var loc = "investments/new-to-investing";
          if(riskRating==1){
            loc = Drupal.settings.investment_profile_builder_save.ratingurl_1;
          } else if(riskRating==2){
            loc = Drupal.settings.investment_profile_builder_save.ratingurl_2;
          }else if(riskRating==3){
            loc = Drupal.settings.investment_profile_builder_save.ratingurl_3;
          }else if(riskRating==4){
            loc = Drupal.settings.investment_profile_builder_save.ratingurl_4;
          }else if(riskRating==5){
            loc = Drupal.settings.investment_profile_builder_save.ratingurl_5;            
          }else if(riskRating==6){          
            loc = Drupal.settings.investment_profile_builder_save.ratingurl_6;                 
          }else if(riskRating==7){          
            loc = Drupal.settings.investment_profile_builder_save.ratingurl_7;          
          }
		  if (loc.indexOf('http') < 0)
		  {
			loc = '/' + loc;
		  }
          if (loc.indexOf('?') < 0)
		  {
			top.location.href = loc+"?source=ipb";
		  }
		  else
		  {
			top.location.href = loc + "&source=ipb";
		  }
          
          $('#irishlife-atrc-disclaimer').append('<center><p class="irishlife-atrc-disclaimer-redirect-link" style="display:none;">If you are not redirected in a few seconds then <a href="'+baseURL+loc+"?source=ipb"+'">click here</a>.</p></center>')
          $('.irishlife-atrc-disclaimer-redirect-link').delay(1000).fadeIn('slow');
	}
  
  
})(jQuery);